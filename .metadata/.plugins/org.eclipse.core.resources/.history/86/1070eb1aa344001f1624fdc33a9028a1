package com.creditoservice.service;

import static org.junit.Assert.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertThrows;
import static org.mockito.ArgumentMatchers.anyString;

import java.util.HashMap;
import java.util.Map;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.Mockito;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import org.springframework.boot.test.autoconfigure.web.client.RestClientTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.test.context.junit.jupiter.SpringExtension;

import com.creditoservice.domain.Taxa;
import com.creditoservice.dto.ClienteApiResponseDTO;
import com.creditoservice.dto.SimulacaoRequestDTO;
import com.creditoservice.dto.SimulacaoResponseDTO;
import com.creditoservice.exception.CpfInvalidoException;
import com.creditoservice.exception.NumeroParcelasInvalidoException;
import com.creditoservice.exception.ValorNecessarioException;
import com.creditoservice.repository.TaxaRepository;

@ExtendWith(SpringExtension.class)
@DataJpaTest
@ComponentScan(basePackages = "com.creditoservice")
@RestClientTest(ClienteApiService.class)
public class SimulacaoServiceTest {

	@Autowired
	private TaxaRepository taxaRepository;
	
    @Autowired
    private SimulacaoService simulacaoService;

    @MockBean
    private ClienteApiService clienteApiService;


    @BeforeEach
    public void setUp() {
        taxaRepository.deleteByTipo("SCORE_MEDIANO");

        Map<Integer, Double> taxasAlto = new HashMap<>();
        taxasAlto.put(6, 0.05);
        taxasAlto.put(12, 0.04);
        taxasAlto.put(18, 0.03);

        Taxa taxaAlto = new Taxa();
        taxaAlto.setTipo("SCORE_MEDIANO");
        taxaAlto.setTaxas(taxasAlto);

        taxaRepository.save(taxaAlto);

        ClienteApiResponseDTO cliente = new ClienteApiResponseDTO();
        cliente.setCpf("12345678901");
        cliente.setNome("Teste");
        cliente.setScore(0);
        cliente.setNegativado(false);

        Mockito.when(clienteApiService.getClienteByCpf(anyString())).thenReturn(cliente);
    }
    @Test
    public void testObterTaxaJurosValido() {
        double taxa = simulacaoService.obterTaxaJuros("NEGATIVADO", 6);
        assertEquals(0.04, taxa);
    }

    @Test
    public void testNumeroParcelasInvalido() {
        assertThrows(NumeroParcelasInvalidoException.class, () -> {
            simulacaoService.obterTaxaJuros("SCORE_ALTO", 0);
        });
    }
    
    @Test
    public void testGetTaxaByTipo() {
        Taxa taxa = simulacaoService.getTaxaByTipo("SCORE_ALTO");
        assertNotNull(taxa);
        assertEquals("SCORE_ALTO", taxa.getTipo());
  
    }
    @Test
    public void testGetTaxaByTipoInvalido() {
        assertThrows(RuntimeException.class, () -> {
            simulacaoService.getTaxaByTipo("SCORE_INVALIDO");
        });
    }
    
    @Test
    public void testSimularEmprestimo() {
        // Configura o request
        SimulacaoRequestDTO request = new SimulacaoRequestDTO();
        request.setValor(10000.0);
        request.setNumeroParcelas(12);

        SimulacaoResponseDTO response = simulacaoService.simularEmprestimo(request, "12345678901");

        assertEquals("Teste", response.getNome());
        assertEquals("R$ 1.171,66", response.getValorParcelas());
        assertEquals(12, response.getNumeroParcelas());
        assertEquals(0.04, response.getTaxaJuros());
        assertEquals("R$ 14.059,94", response.getValorParcelas());
        assertEquals(600, response.getScore());
        assertEquals("SCORE_ALTO", response.getTipoScore());
    }

    @Test
    public void testSimularEmprestimoCpfInvalido() {
        Mockito.when(clienteApiService.getClienteByCpf(anyString())).thenReturn(null);

        SimulacaoRequestDTO request = new SimulacaoRequestDTO();
        request.setValor(10000.0);
        request.setNumeroParcelas(12);

        assertThrows(CpfInvalidoException.class, () -> {
            simulacaoService.simularEmprestimo(request, "00000000000");
        });
    }

    @Test
    public void testSimularEmprestimoValorNecessarioException() {
        SimulacaoRequestDTO request = new SimulacaoRequestDTO();
        request.setValor(0.0);
        request.setNumeroParcelas(12);

        assertThrows(ValorNecessarioException.class, () -> {
            simulacaoService.simularEmprestimo(request, "12345678901");
        });
    }
}

