package com.creditoservice.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.creditoservice.domain.Taxa;
import com.creditoservice.dto.ClienteApiResponseDTO;
import com.creditoservice.dto.SimulacaoRequestDTO;
import com.creditoservice.dto.SimulacaoResponseDTO;
import com.creditoservice.exception.TipoTaxaIndeterminadoException;
import com.creditoservice.repository.TaxaRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@Service
public class SimulacaoService {

	private static final Logger logger = LoggerFactory.getLogger(SimulacaoService.class);

	@Autowired
	private ClienteApiService clienteApiService;

	@Autowired
	private TaxaRepository taxaRepository;

	public SimulacaoResponseDTO simularEmprestimo(SimulacaoRequestDTO request, String cpf) {
		ClienteApiResponseDTO cliente = clienteApiService.getClienteByCpf(cpf);
		if (cliente == null) {
			throw new RuntimeException("Cliente não encontrado");
		}

		int score = cliente.getScore();
		String nome = cliente.getNome();
		String tipoScore = determinarTipoTaxa(cliente);

		String tipoTaxa = determinarTipoTaxa(cliente);
		double taxa = obterTaxaJuros(tipoTaxa, request.getNumeroParcelas());

		double valorFinal = calcularValorFinal(request.getValor(), taxa, request.getNumeroParcelas());
		double valorParcelas = calcularValorParcelas(valorFinal, request.getNumeroParcelas());

		return new SimulacaoResponseDTO(valorFinal, taxa, valorParcelas, request.getNumeroParcelas(), score, tipoScore,
				nome);
	}

	private String determinarTipoTaxa(ClienteApiResponseDTO cliente) {
		if (cliente.isNegativado()) {
			return "NEGATIVADO";
		} else if (cliente.getScore() > 500) {
			return "SCORE_ALTO";
		} else if (cliente.getScore() <= 499) {
			return "SCORE_BAIXO";
		} else {
			throw new TipoTaxaIndeterminadoException(
					"Tipo de taxa não pode ser determinado para o cliente com CPF: " + cliente.getCpf());
		}
	}

	private double obterTaxaJuros(String tipoTaxa, int numeroParcelas) {
		Taxa taxaJuros = getTaxaByTipo(tipoTaxa);
		Double taxa = taxaJuros.getTaxas().get(numeroParcelas);
		if (taxa == null) {
			throw new IllegalArgumentException("Número de parcelas inválido");
		}
		return taxa;
	}

	private double calcularValorFinal(double valor, double taxa, int numeroParcelas) {
		return valor * Math.pow(1 + taxa, numeroParcelas);
	}

	private double calcularValorParcelas(double valorFinal, int numeroParcelas) {
		return valorFinal / numeroParcelas;
	}

	public Taxa getTaxaByTipo(String tipo) {
		return taxaRepository.findByTipo(tipo)
				.orElseThrow(() -> new RuntimeException("Taxa não encontrada para o tipo: " + tipo));
	}
}
